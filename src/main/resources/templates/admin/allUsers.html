<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Список пользователей</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>

        .logout-button {
            position: fixed;
            right: 50px;
            top: 0px;
            background-color: transparent; /*  цвет фона */
            color: #989393; /* Цвет текста */
            padding: 10px 20px; /* Внутренние отступы */
            border: none; /* Убрать границу */
            border-radius: 5px; /* Скругленные углы */
            font-size: 16px; /* Размер шрифта */
            cursor: pointer; /* Курсор в виде указателя */
        }

        .logout-button:hover {
            background-color: #d80c26; /* цвет при наведении */
            color: white; /* цвет текста при наведении */
        }
        /* Стили для полосы */
        .user-bar {
            background-color: rgba(18, 16, 16, 0.8); /*  фон */
            color: white;
            padding: 10px 0;
        }
        .tab {
            display: inline-block;
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f8f9fa; /* Цвет фона вкладок */
            color: darkgrey; /* Цвет текста неактивной вкладки */
            border-radius: 0px;
            margin-right: 5px; /* Отступ между вкладками */
        }
        .tab.active {
            background-color: white; /*  цвет фона активной вкладки */
            color: #343a40; /*  цвет текста активной вкладки */
            border: 2px solid #e6e6e6;/* цвет контура */
            border-bottom: none;
        }
        .tab:hover {
            background-color: white;
            color: #343a40;
        }
        .light-blue {
            color: #add8e6; /* Светло-голубой цвет текста */
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,.05); /* Чередование цветов строк */
        }
        .sidebar {
            position: fixed; /* Фиксированное положение */
            left: 0; /* Прижать к левому краю */
            top: 50px; /* Прижать к верху */
            width: 250px; /* Ширина колонки */
            background: #fff; /* Белый фон */
            height: 100vh; /* Высота на весь экран */
            padding: 10px; /* Внутренние отступы */
            box-sizing: border-box; /* Размеры включают padding */
        }

        /* Обновленные стили для кнопок */
        .nav-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            background: transparent; /* Прозрачный фон */
            text-align: left;
            border: none; /* Убрать границу */
            outline: none; /* Убрать контур */
            cursor: pointer; /* Курсор в виде указателя */
            transition: background-color 0.3s; /* Плавное изменение фона */
        }
        .nav-button:hover {
            background-color: #e0e0e0; /* Цвет фона при наведении */
        }
        .nav-button.active {
            background-color: #007bff; /* Синий цвет активной кнопки */
            color: white; /* Белый текст */
        }
        .main-content {
            margin-left: 170px; /* Отступ слева равен ширине .sidebar + padding */
        }

        .container {
            margin-left: 170px;
        }
        /* Стили для кнопки редактирования */
        #edit-user {
            background-color: #1e60d5; /* светло-синий цвет */
            color: white; /* белый текст */
            border: none; /* без рамки */
        }

        #edit-user i {
            margin-right: 5px; /* отступ иконки от текста */
        }

        /* Стили для кнопки удаления */
        #delete-user {
            background-color: red; /* красный цвет */
            color: white; /* белый текст */
            border: none; /* без рамки */
        }

        #delete-user i {
            margin-right: 5px; /* отступ иконки от текста */
        }
    </style>
</head>
<body>
<!-- Левая боковая колонка -->
<div class="sidebar">
    <button class="nav-button active" onclick="location.href='/admin/'">Панель администратора</button>
    <button class="nav-button" onclick="location.href='/user'">Информация о пользователе</button>
</div>
<!-- Полоса в верхней части страницы -->
<div class="user-bar">
    <div class="container">
        <div class="row">
            <div class="col">
                <span th:text="${user.name}"></span> -
                <span th:each="role : ${user.roles}" th:text="${role.roleName} + (iterStat.last ? '' : ', ')"></span>
            </div>
            <div class="col text-right">
                <a href="/logout" class="btn btn-primary logout-button">Logout</a>
            </div>
        </div>
    </div>
</div>
<div id="add-user-form" class="container mt-3" style="display: none;">
    <!-- Форма добавления нового пользователя -->
    <!-- ... -->
</div>
<div class="main-content">
<div class="container mt-5">
    <h1>Панель администратора</h1>
</div>
<div class="container mt-3">
    <a href="/admin/" class="tab active">Таблица пользователей</a>
<!--    <a href="/admin/add" class="tab light-blue">Добавить нового пользователя</a>-->
    <a href="javascript:void(0);" class="tab light-blue" onclick="showAddUserForm()">Добавить нового пользователя</a>
</div>
<div class="container mt-3">
    <h2>Все пользователи</h2>
    <table class="table table-responsive table-striped">
        <!-- Заголовки и строки таблицы -->
        <thead class="thead-light">
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Фамилия</th>
            <th>Возраст</th>
            <th>Роли</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${usersList}">
            <td th:text="${user.id}">id</td>
            <td th:text="${user.name}">Имя</td>
            <td th:text="${user.surname}">Фамилия</td>
            <td th:text="${user.age}">Возраст</td>
            <td>
                <ul>
                    <li th:each="role : ${user.roles}" th:text="${role.roleName}">Роль</li>
                </ul>
            </td>
            <td>
                <button id="edit-user" type="button" class="btn btn-success" data-toggle="modal" data-target="#userEditDialog" th:data-userId="${user.id}"><i class="fas fa-edit"></i> Редактировать</button>
                <button id="delete-user" type="button" class="btn btn-danger" data-toggle="modal" data-target="#userDeleteDialog" th:data-userId="${user.id}"><i class="fas fa-trash-alt"></i> Удалить</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>
</div>
<div class="modal fade" id="userEditDialog" tabindex="-1" role="dialog" aria-labelledby="userEditDialogLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userEditDialogLabel">Edit user</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="user-id">
                    <div class="form-group">
                        <label for="user-name" class="col-form-label">User name</label>
                        <input type="text" class="form-control" id="user-name">
                        <div id="user-name-error" class="validation-error" style="display: none; color: red;"></div>
                    </div>
                    <div class="form-group">
                        <label for="user-surname" class="col-form-label">Surname</label>
                        <input type="text" class="form-control" id="user-surname">
                        <div id="user-surname-error" class="validation-error" style="display: none; color: red;"></div>
                    </div>
                    <div class="form-group">
                        <label for="user-age" class="col-form-label">Age</label>
                        <input type="number" class="form-control" id="user-age">
                        <div id="user-age-error" class="validation-error" style="display: none; color: red;"></div>
                    </div>
                    <div class="form-group">
                        <label for="user-password" class="col-form-label">Password</label>
                        <input type="password" class="form-control" id="user-password">
                        <div id="user-password-error" class="validation-error" style="display: none; color: red;"></div>
                    </div>
                    <div class="form-group">
                        <label for="user-roles" class="col-form-label">Roles</label>
                        <select class="form-control" id="user-roles" multiple>
                            <option value="ROLE_ADMIN">ROLE_ADMIN</option>
                            <option value="ROLE_USER">ROLE_USER</option>
                            <option value="ROLE_GUEST">ROLE_GUEST</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="save-user-button" type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно удаления пользователя -->
<div class="modal fade" id="userDeleteDialog" tabindex="-1" role="dialog" aria-labelledby="userDeleteDialogTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form>
                <div class="modal-header">
                    <h5 class="modal-title" id="userDeleteDialogTitle">Удаление пользователя</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить пользователя?</p>
                    <div class="form-group">
                        <label for="delete-user-id">ID:</label>
                        <input type="text" id="delete-user-id" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="delete-user-name">Имя:</label>
                        <input type="text" id="delete-user-name" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="delete-user-surname">Фамилия:</label>
                        <input type="text" id="delete-user-surname" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="delete-user-age">Возраст:</label>
                        <input type="text" id="delete-user-age" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="user-roles-list">Роли:</label>
                        <input type="text" id="user-roles-list" class="form-control" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">Удалить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Ваш JavaScript код для обработки формы -->

<!-- Подключение JavaScript библиотеки Bootstrap для работы модального окна -->
<!--<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>-->
<!--<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>-->

<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

<script>

    // Функция для отображения сообщения об ошибке
    function showValidationError(selector, message) {
        let modal = $('#userEditDialog');
        let errorContainer = modal.find(selector);
        errorContainer.text(message);
        errorContainer.show();
    }

    // Функция для скрытия сообщений об ошибках
    function clearValidationErrors() {
        let modal = $('#userEditDialog');
        modal.find('.validation-error').hide(); // Скрываем все элементы с классом 'validation-error'
    }


    $('#userEditDialog').on('shown.bs.modal', function (event) {
        let button = $(event.relatedTarget); // Кнопка, которая вызвала модальное окно
        let userId = button.data('userid'); // Извлечение информации из атрибутов data-*

        if (userId) {
            $.get({
                url: '/api/v1/user/' + userId,
                success: (userData) => {
                    let modal = $(this);
                    modal.find('#user-id').val(userData.id);
                    modal.find('#user-name').val(userData.name);
                    modal.find('#user-password').val(userData.password);
                    modal.find('#user-surname').val(userData.surname);
                    modal.find('#user-age').val(userData.age);

                    // Запрос списка ролей с сервера
                    $.get({
                        url: '/api/v1/roles',
                        success: (rolesData) => {
                            let rolesSelect = modal.find('#user-roles');
                            rolesSelect.empty(); // Очистка предыдущих опций
                            rolesData.forEach(function(role) {
                                let isSelected = userData.roles.some(userRole => userRole.roleName === role.roleName);
                                rolesSelect.append(new Option(role.roleName, role.roleName, isSelected, isSelected));
                            });
                        },
                        error: (err) => {
                            console.error('Ошибка при получении ролей:', err);
                        }
                    });
                },
                error: (err) => {
                    alert('Ошибка при получении данных пользователя:', err);
                }
            });
        }
    });

    // Функция валидации данных формы
    function validateUserData(user) {
        clearValidationErrors(); // Очистка предыдущих ошибок
        let isValid = true;

        // Паттерн для имени: только буквы, от 2 до 30 символов
        const namePattern = /^[а-яА-ЯёЁa-zA-Z]{2,30}$/;
        if (!namePattern.test(user.name)) {
            showValidationError('#user-name-error', 'Имя должно содержать только буквы и быть длиной от 2 до 30 символов.');
            isValid = false;
        }

        // Паттерн для фамилии: только буквы, от 2 до 30 символов
        const surnamePattern = /^[а-яА-ЯёЁa-zA-Z]{2,30}$/;
        if (!surnamePattern.test(user.surname)) {
            showValidationError('#user-surname-error', 'Фамилия должна содержать только буквы и быть длиной от 2 до 30 символов.');
            isValid = false;
        }

        // Проверка возраста: должен быть больше 0
        if (user.age <= 0) {
            showValidationError('#user-age-error', 'Возраст должен быть больше 0.');
            isValid = false;
        }

        return isValid;
    }


    $('#save-user-button').off('click').on('click', function() {
        let modal = $('#userEditDialog');
        let selectedRoles = modal.find('#user-roles').val(); // Получение выбранных ролей
        let rolesArray = selectedRoles.map(roleName => ({ roleName }));
        let ageValue = modal.find('#user-age').val();
        let age = ageValue ? parseInt(ageValue) : null; // Если ageValue не пустое, преобразуем в число, иначе null

        let user = {
            name: modal.find('#user-name').val(),
            password: modal.find('#user-password').val(),
            surname: modal.find('#user-surname').val(),
            age: age, // Используем переменную age, определенную выше
            roles: rolesArray // Установка ролей как массива объектов
        };

        if (!validateUserData(user)) {
            return; // Прерываем выполнение, если данные не прошли валидацию
        }

        // Получение userId из модального окна или другого источника
        let userId = modal.find('#user-id').val() ;

        if (userId) {
            user.id = userId; // Установка ID пользователя, если он определен
            $.ajax({
                url: '/api/v1/user/' + userId, // Добавление слэша перед userId
                type: 'PUT',
                data: JSON.stringify(user),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: () => {
                    location.reload(); // Перезагрузка страницы после успешного сохранения
                },
                error: (err) => {
                    alert(err.responseText || 'Произошла ошибка при сохранении пользователя.');
                }
            });
        } else {
            console.error('UserID не определен.'); // Логирование ошибки, если userId не определен
        }

        modal.modal('hide'); // Закрытие модального окна
    });


    $('#userDeleteDialog').on('shown.bs.modal', function (event) {
        let button = $(event.relatedTarget); // Кнопка, которая вызвала модальное окно
        let userId = button.data('userid'); // Извлечение информации из атрибутов data-*

        $.get({
            url: '/api/v1/user/' + userId,
            success: (userData) => {
                let modal = $('#userDeleteDialog');
                modal.find('#delete-user-id').val(userData.id);
                modal.find('#delete-user-name').val(userData.name);
                modal.find('#delete-user-surname').val(userData.surname);
                modal.find('#delete-user-age').val(userData.age);
                fetch(`/api/v1/${userId}/roles`)
                    .then(response => response.json())
                    .then(roles => {
                        if (Array.isArray(roles)) {
                            // Создаем строку со всеми ролями для отображения
                            const rolesList = roles.join(', ');
                            modal.find('#user-roles-list').val(rolesList);
                        } else {
                            console.error('Ожидался массив ролей, но получен:', roles);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при получении ролей:', error);
                    });
            },
            error: (err) => {
                alert('Ошибка при получении данных пользователя:', err);
            }
        });
    });

    // Обработчик события 'click' для кнопки 'confirm-delete'
    $('#confirm-delete').on('click', function() {
        let userId = $('#delete-user-id').val(); // Получение ID пользователя из модального окна
        $.ajax({
            url: '/api/v1/user/' + userId,
            type: 'DELETE',
            success: () => {
                location.reload(); // Обновление интерфейса или перезагрузка страницы
            },
            error: (err) => {
                alert('Ошибка при удалении пользователя:', err);
            }
        });
    });
</script>

</body>
</html>